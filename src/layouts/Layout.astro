---
import "../styles/global.css";
import Header from "../components/Header.astro";
import Hexagons from "../components/Hexagons.astro";

interface Props {
    title: string;
}

const { title } = Astro.props;
---

<!doctype html>
<html lang="es" class="scroll-smooth dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="generator" content={Astro.generator} />
        <title>{title}</title>
        <meta
            name="description"
            content="Stickers que respiran. Tecnología fotocatalítica para un aire más limpio."
        />

        <!-- Google Fonts: Outfit -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap"
            rel="stylesheet"
        />
    </head>
    <body
        class="bg-black text-body overflow-x-hidden selection:bg-primary selection:text-white"
    >
        <Header />

        <!-- Ambient Background Glows (CSS) -->
        <div
            id="glow-1"
            class="fixed top-[20%] left-1/2 -translate-x-1/2 lg:translate-x-0 md:top-[-40%] lg:left-[-10%] w-[200vw] md:w-[100vw] lg:w-[60vw] h-[100vw] md:h-[100vw] lg:h-[60vw] rounded-full bg-primary/10 blur-[80px] md:blur-[120px] pointer-events-none z-0 mix-blend-screen scale-0 opacity-0"
        >
        </div>

        <!-- Geometric Background -->
        <Hexagons />

        <!-- Global Noise Texture (Background) -->
        <div
            class="fixed inset-0 z-0 pointer-events-none opacity-[0.8] mix-blend-overlay"
        >
            <div
                class="absolute inset-0 bg-repeat w-full h-full animate-noise"
                style="background-image: url('data:image/svg+xml,%3Csvg viewBox=%220 0 200 200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22noiseFilter%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%221.5%22 numOctaves=%222%22 stitchTiles=%22stitch%22/%3E%3CfeColorMatrix type=%22saturate%22 values=%220%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23noiseFilter)%22/%3E%3C/svg%3E');"
            >
            </div>
        </div>

        <main class="relative z-10">
            <slot />
        </main>
        <script>
            import Lenis from "lenis";
            import gsap from "gsap";
            import { ScrollTrigger } from "gsap/ScrollTrigger";

            // Initialize Lenis
            const lenis = new Lenis({
                lerp: 0.1,
                smoothWheel: true,
            });

            // Synchronize Lenis with GSAP ScrollTrigger
            lenis.on("scroll", ScrollTrigger.update);

            gsap.ticker.add((time) => {
                lenis.raf(time * 1000);
            });

            gsap.ticker.lagSmoothing(0);

            // --- Entrance Animations ---
            const tl = gsap.timeline({
                defaults: { ease: "power3.out" },
            });

            // 1. Ambient Background Glows (Scale Up & Fade In)
            // Sync starts immediately but takes time to build up ambiance
            tl.to(
                "#glow-1",
                {
                    scale: 1,
                    opacity: 1,
                    duration: 5,
                    ease: "power1.inOut",
                },
                0,
            );

            // 2. Navbar (Header) Entrance
            // Drops down after a slight delay to let the 3D scene start
            tl.to(
                "#main-header",
                {
                    y: 0,
                    opacity: 1,
                    duration: 1.5,
                    ease: "power4.out",
                },
                1.0,
            );

            // 3. Background Transition (Info Section)
            // Fade out glow and move hexagons
            const bgTl = gsap.timeline({
                scrollTrigger: {
                    trigger: "#info-section", // Target the info-section ID physically in the DOM
                    start: "top 80%", // Start earlier to catch the scroll
                    end: "center center",
                    scrub: 1,
                },
            });

            // Fade out the main glow
            // immediateRender: false prevents GSAP from recording the initial '0' value before entrance finishes
            bgTl.to(
                "#glow-1",
                {
                    opacity: 0,
                    duration: 1,
                    ease: "power1.out",
                    immediateRender: false,
                },
                0,
            );

            // --- Updated Background Animation ---

            // 1. Solid Hexagons (1 & 3) -> Fade Out
            bgTl.to(
                [".hex-1", ".hex-3"],
                {
                    opacity: 0,
                    scale: 0.5,
                    duration: 1,
                    ease: "power1.out",
                    immediateRender: false,
                },
                0,
            );

            // 2. Outline Hexagons (2 & 4) -> Center perfectly
            // Using top/right 50% + percent translation for robust centering

            // Hex 2 (Large Outline)
            bgTl.to(
                ".hex-2",
                {
                    top: "50%",
                    right: "50%",
                    xPercent: 50, // Move right by 50% of own width to center
                    yPercent: -50, // Move up by 50% of own height to center
                    x: 0, // Reset any other transforms
                    y: 0,
                    rotation: 0,
                    scale: 1,
                    ease: "power2.inOut",
                    immediateRender: false,
                },
                0,
            );

            // Hex 4 (Small Outline)
            bgTl.to(
                ".hex-4",
                {
                    top: "50%",
                    right: "50%",
                    xPercent: 50,
                    yPercent: -50,
                    x: 0,
                    y: 0,
                    rotation: 0,
                    scale: 1,
                    ease: "power2.inOut",
                    immediateRender: false,
                },
                0,
            );

            // --- Lab Section Background Animation ---
            // Move hexagons to right to frame the 3D sticker
            const labBgTl = gsap.timeline({
                scrollTrigger: {
                    trigger: "#lab-section",
                    start: "top bottom",
                    end: "center center",
                    scrub: 1,
                    immediateRender: false,
                },
            });

            // Hex 2 (Large Outline) -> Move Right & Rotate
            labBgTl.to(
                ".hex-2",
                {
                    left: "auto",
                    right: "20%", // Position behind the sticker
                    xPercent: 50,
                    rotation: 60, // Tech rotation
                    scale: 1.2, // Pulse up
                    ease: "power2.inOut",
                },
                0,
            );

            // Hex 4 (Small Outline) -> Move Right & Counter-Rotate
            labBgTl.to(
                ".hex-4",
                {
                    left: "auto",
                    right: "20%",
                    xPercent: 50,
                    rotation: -60,
                    scale: 0.8,
                    ease: "power2.inOut",
                },
                0,
            );
        </script>
    </body>

    <style is:global>
        :root {
            --font-sans: "Outfit", sans-serif;
        }
        html {
            font-family: var(--font-sans);
        }

        /* Recommended CSS for Lenis */
        html.lenis,
        html.lenis body {
            height: auto;
        }
        .lenis.lenis-smooth {
            scroll-behavior: auto !important;
        }
        .lenis.lenis-smooth [data-lenis-prevent] {
            overscroll-behavior: contain;
        }
        .lenis.lenis-stopped {
            overflow: hidden;
        }
        .lenis.lenis-scrolling iframe {
            pointer-events: none;
        }

        /* Noise Animation */
        @keyframes noise-shift {
            0% {
                background-position: 0px 0px;
            }
            10% {
                background-position: -5% -5%;
            }
            20% {
                background-position: -10% 5%;
            }
            30% {
                background-position: 5% -10%;
            }
            40% {
                background-position: -5% 15%;
            }
            50% {
                background-position: -10% 5%;
            }
            60% {
                background-position: 15% 0px;
            }
            70% {
                background-position: 0px 10%;
            }
            80% {
                background-position: -15% 0px;
            }
            90% {
                background-position: 10% 5%;
            }
            100% {
                background-position: 5% 0px;
            }
        }

        .animate-noise {
            animation: noise-shift 0.2s steps(1) infinite;
        }
    </style>
</html>
